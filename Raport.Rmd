---
title: "Report - herring fish size data analysys"
author: "Marcin Berendt"
date: "13 grudnia 2016"
output: html_document
---

###1.Kod wyliczaj¹cy wykorzystane biblioteki  
```{r setup,  warning=FALSE, error=FALSE}
library(knitr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)
library(shiny)
library(tidyverse)
library(gplots)
library(rpart)
library(randomForest)

knitr::opts_chunk$set(echo = TRUE)
```

###2.Kod pozwalaj¹cy wczytaæ dane z pliku    

```{r reading data from file to data.frame}
sledzie <- read.csv("sledzie.csv")
```

###3.Kod przetwarzaj¹cy brakuj¹ce dane  
```{r processing missing values}

```

###4.Sekcjê podsumowuj¹c¹ rozmiar zbioru i podstawowe statystyki  
```{r summary section}
knitr::kable(summary(sledzie))
```

###5.Szczegó³ow¹ analizê wartoœci atrybutów  
```{r distributed values analysis}
str(sledzie)
```


###6.Interaktywny wykres lub animacjê prezentuj¹c¹ zmianê rozmiaru œledzi w czasie  

```{r changes in size trough time}
sledzie_asc_xmonth  <- arrange(sledzie, xmonth)

dsamp <- sledzie[sample(nrow(sledzie_asc_xmonth), 1000), ]

ggplot(sledzie_asc_xmonth, aes(x=xmonth, y=length)) + geom_bar(
  stat="identity",
  position=
      "identity")
```

###7. Wczytanie danych i i przetworzenie brakujacych danych  
```{r}

# 3. wczytanie danych i 4. przetworzenie brakuj¹cych danych
sledzie <- read.csv("sledzie.csv", na.strings = "?")
# sledzie <- sledzie[, -1] # usuwam pierwszy wiersz z numeracja wierszy od 0 do n-1

```
### 9. Podsumowanie rozmiaru danych i podstawowe statystyki  

```{r data size and statistics}
dim(sledzie)
str(sledzie)
summary(sledzie)
```

### 10. Sprawdzenie iloœci brakuj¹cych elementów w zbiorze danych (liczbowo)  
```{r checking how many missing values actually exists}
apply(sledzie, 2, function(x) sum(is.na(x)))

```

### 11. Sprawdzenie iloœci brakuj¹cych elementów w zbiorze danych (procentowo)   
```{r how many missing values - percentage}
apply(sledzie, 2, function(x) sum(is.na(x))/length(x)) # ok 0,03%
```

### 12. Zast¹pienie brakuj¹cych elementóW œredni¹   

```{r replacing missing values with average value}
sledzie <- data.frame(apply(sledzie, 2, function(x) {
  ind <- which(is.na(x))
  srednia <- mean(x, na.rm = TRUE)
  x[ind] <- srednia
  x
}))

```

### 13.Zamiast zastapienia brakujacych wartosci srednia, mozna je takze pominac (alternatywne rozwiazanie) (uzycie uzyc complete obs przy cor() lub  sledzie <- na.omit(sledzie)    
```{r avoiding missing values}
sledzie <- na.omit(sledzie)
```

### 14. Prezentacja rozkladow wartoœci  

```{r }
for (i in colnames(sledzie)) {
  print(
    ggplot(data = sledzie,
           aes_string(
             x = i
           )) +
      geom_density(fill = "lightskyblue") +
      ggtitle(i)
  )
}
```

### 15. Pokazanie korelacji pomiêdzy poszczególnymi parametrami / zmiennymi  
#### Zmienne oprocz 'length' nie maja rozk³adu normalnego. Zdecydowa³em siê wiêc na u¿ycie wspolczynnika korelacji spearmana  
```{r}
korelacja <- cor(sledzie, method = "spearman", use = "complete.obs")

my_palette <- colorRampPalette(c("green", "black", "red"))(n = 30)

# rysuje heatmape korelacji
heatmap.2(korelacja,
          col = my_palette,
          trace = "none",
          main = "Heatmapa korelacji",
          cellnote = round(korelacja, 2),
          notecol = "grey")
```
### 16. Wykres prezentuj¹cy zmianê rozmiaru sledzi w czasie  

```{r}
ggplot(data = sledzie,
       aes(x = X,
           y = length)) +
  geom_point() +
  ggtitle("Wykres przedstawiajacy zmiane rozmiaru z³owionego œledzia w czasie") +
  geom_smooth()

```

### 17. Regresor przewidujacy rozmiar sledzia  
```{r}
fit <- lm(length ~ ., data = sledzie)
summary(fit)

# wyciagam R^2
summary(fit)$r.squared 

# Function that returns Root Mean Squared Error
rmse <- function(error)
{
  sqrt(mean(error^2))
}
rmse(fit$residuals)

# drzewo regresyjne
fit2 <- rpart(length ~ ., data = sledzie, method = "anova")
printcp(fit2) # wyniki
plotcp(fit2) # wizualizacja cross-validation
print(fit2) # nudy
summary(fit2) # podsumowanie splitow
par(mfrow = c(1, 2))
rsq.rpart(fit2) # jak zmienia sie r^2 przy danej ilosci splitow
par(mfrow = c(1, 1))
plot(fit2, uniform = TRUE, main = "Drzewo regresji dla rozmiaru po³awianego œledzia")
text(fit2, use.n = TRUE, cex = 1)

# random forest
fit3 <- randomForest(length ~ ., data = na.omit(sledzie))
print(fit3)
waznosc <- importance(fit3)
waznosc <- data.frame(zmienna = rownames(waznosc), wartosc = waznosc[, 1])
waznosc$zmienna <- factor(waznosc$zmienna, levels = waznosc[order(waznosc$wartosc), "zmienna"])

ggplot(waznosc,
       aes(x = zmienna,
           y = wartosc)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  ggtitle("Waznosc zmiennych dla randomForest")


# najwazniejsza zmienna sst
# rysuje scatterplot
ggplot(data = sledzie,
       aes(x = length,
           y = sst)) +
  geom_point() +
  geom_smooth(method = "lm")

cor.test(sledzie$length, sledzie$sst)

```